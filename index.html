<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RescueCards V3 (Cockpit)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        :root {
            --primary: #0056b3;
            --bg: #eceff1;
            --text: #263238;
            
            /* Sektions-Farben */
            --col-ab: #0288d1; /* Blau */
            --col-c:  #d32f2f; /* Rot */
            --col-d:  #fbc02d; /* Gelb */
            --col-e:  #388e3c; /* Gr√ºn */
            
            /* Kategorien Header */
            --cat-neuro: #8e44ad; --cat-meta: #f39c12; --cat-resp: #27ae60; 
            --cat-cardio: #c0392b; --cat-trauma: #2980b9; --cat-other: #78909c;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        
        header { background: #263238; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; margin-top: 10px; background: #37474f; color: white; }
        input::placeholder { color: #b0bec5; }

        /* Nav */
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        nav button { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #90a4ae; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        nav button.active { color: var(--col-ab); background: #e1f5fe; }

        /* Views */
        .view-section { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* --- CARD DESIGN V3 --- */
        .card { background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #cfd8dc; }
        
        /* Header */
        .card-header { padding: 12px 15px; color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .neuro { background: var(--cat-neuro); } .meta { background: var(--cat-meta); } 
        .resp { background: var(--cat-resp); } .cardio { background: var(--cat-cardio); } 
        .trauma { background: var(--cat-trauma); } .other { background: var(--cat-other); }

        .card-preview { padding: 15px; cursor: pointer; }
        .def-text { font-style: italic; color: #546e7a; margin-bottom: 5px; font-size: 0.95rem; }
        
        /* Details Container */
        .card-details { display: none; background: #fff; }
        .card-details.open { display: block; }

        /* ‚ö†Ô∏è Leitsymptome Box */
        .symptom-box { background: #fff8e1; color: #f57f17; padding: 12px 15px; border-bottom: 1px solid #ffe082; display: flex; gap: 10px; align-items: start; }
        .symptom-box .icon { font-size: 1.2rem; }
        .symptom-box .text { font-weight: 700; font-size: 0.95rem; line-height: 1.4; }

        /* üìü Vital-Cockpit (Das Herzst√ºck) */
        .cockpit { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; }
        .vital-tile { background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .vital-label { font-size: 0.7rem; color: #78909c; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .vital-val { font-weight: 800; font-size: 1rem; color: #37474f; }
        
        /* Dynamische Farben f√ºr Pfeile */
        .trend-up { color: #d32f2f !important; } /* Rot bei Hoch */
        .trend-down { color: #1976d2 !important; } /* Blau bei Niedrig */

        /* ABCDE Sections */
        .abc-section { padding: 10px 15px; border-bottom: 1px solid #eee; position: relative; }
        .abc-section.sec-ab { border-left: 5px solid var(--col-ab); }
        .abc-section.sec-c { border-left: 5px solid var(--col-c); }
        .abc-section.sec-d { border-left: 5px solid var(--col-d); }
        .abc-section.sec-e { border-left: 5px solid var(--col-e); }

        .sec-title { font-size: 0.75rem; font-weight: 900; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        
        /* Grid Layout f√ºr Inhalte */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-full { grid-column: 1 / -1; }
        
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 0.7rem; color: #90a4ae; font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }
        .info-val { font-size: 0.95rem; color: #263238; font-weight: 500; line-height: 1.3; }

        /* üöë Action Bar (Footer) */
        .action-bar { background: #263238; color: white; padding: 12px 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .action-item { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .action-icon { font-size: 1.2rem; }
        .nef-badge { background: #c62828; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: auto; }

        /* Differenzierung */
        .diff-box { background: #fff3e0; padding: 10px 15px; border-top: 1px solid #ffe0b2; font-size: 0.9rem; color: #e65100; }

        /* Loading & Error */
        #status-msg { text-align: center; padding: 40px 20px; color: #666; }
        .error-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; text-align: left; font-size: 0.85rem; border: 1px solid #ef9a9a; display: inline-block; }

        /* Compare & Quiz */
        .comp-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; background: white; border-radius: 8px; overflow: hidden; }
        .comp-table th { background: #cfd8dc; padding: 10px; text-align: left; font-size: 0.75rem; color: #455a64; }
        .comp-table td { border-bottom: 1px solid #eee; padding: 12px; vertical-align: top; width: 50%; white-space: pre-wrap; border-right: 1px solid #eee; }
        .diff { background: #fffde7; }
        
        .quiz-box { background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn { background: var(--col-ab); color: white; padding: 14px 30px; border-radius: 30px; border: none; font-size: 1rem; margin-top: 15px; cursor: pointer; width: 100%; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<header>
    <h1>üöë RescueCards <small>v3</small></h1>
    <input type="text" id="search" placeholder="Suche (z.B. Dyspnoe, Schock)..." onkeyup="renderCards()">
</header>

<div id="status-msg">
    <h3>Lade Daten...</h3>
    <p>‚è≥</p>
</div>

<!-- VIEWS -->
<div id="learn" class="view-section">
    <div id="card-container"></div>
</div>

<div id="compare" class="view-section">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <select id="s1" onchange="renderCompare()" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></select>
        <select id="s2" onchange="renderCompare()" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></select>
    </div>
    <div id="compare-result"></div>
</div>

<div id="quiz" class="view-section">
    <div class="quiz-box">
        <p style="color:#90a4ae; font-size:0.8rem; text-transform:uppercase; font-weight:bold; letter-spacing:1px;">Fallbeispiel</p>
        <h3 id="q-text" style="font-size:1.2rem; min-height:80px; margin-bottom:20px; line-height:1.5;">Lade Frage...</h3>
        <button class="btn" onclick="solveQuiz()">Aufl√∂sen</button>
        <div id="q-sol" style="display:none; margin-top:25px; text-align:left; background:#f5f5f5; padding:20px; border-radius:8px; border:1px solid #eee;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <span id="q-sol-icon" style="font-size:2rem;"></span>
                <h2 id="q-sol-title" style="margin:0; font-size:1.4rem; color:#37474f;"></h2>
            </div>
            <div style="font-size:1rem; color:#546e7a; white-space: pre-wrap; line-height:1.6;" id="q-sol-desc"></div>
            <button class="btn" style="background:transparent; border:2px solid var(--col-ab); color:var(--col-ab); margin-top:20px;" onclick="nextQuiz()">N√§chste Frage</button>
        </div>
    </div>
</div>

<nav>
    <button onclick="nav('learn')" id="btn-learn">üóÇÔ∏è Karten</button>
    <button onclick="nav('compare')" id="btn-compare">‚öñÔ∏è Vergleich</button>
    <button onclick="nav('quiz')" id="btn-quiz">üß† Quiz</button>
</nav>

<script>
    // --- LINK KONFIGURATION ---
    const GOOGLE_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBMZadFA7O2nMGOeaUcnEZz5MuNW2WeHdmSU_m94SI9VDdUiI8AfsJXJ-KAhtxv0zRZ6pkRIM_jj1X/pub?gid=1914308692&single=true&output=csv";
    const PROXY_URL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(GOOGLE_CSV_LINK);
    
    let db = [];

    // --- INIT ---
    async function init() {
        const statusEl = document.getElementById('status-msg');
        try {
            await loadData(GOOGLE_CSV_LINK);
        } catch (e1) {
            try { await loadData(PROXY_URL); } 
            catch (e2) {
                statusEl.innerHTML = `<h3>‚ùå Ladefehler</h3><div class="error-box">Bitte Internet pr√ºfen oder Seite neu laden.<br><small>${e2.message}</small></div>`;
            }
        }
    }

    function loadData(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    db = results.data.filter(row => row.id && row.name);
                    if(db.length > 0) {
                        document.getElementById('status-msg').style.display = 'none';
                        nav('learn'); renderCards(); initCompare(); nextQuiz(); resolve();
                    } else { reject(new Error("Leere Tabelle")); }
                },
                error: function(err) { reject(new Error(err.message)); }
            });
        });
    }

    // --- HELPER: Pfeil-Erkennung ---
    function formatValue(val) {
        if (!val) return "";
        // F√§rbe Pfeile ein: Hoch=Rot, Niedrig=Blau
        let style = "";
        if (val.includes("‚¨ÜÔ∏è") || val.toLowerCase().includes("hoch")) style = "trend-up";
        if (val.includes("‚¨áÔ∏è") || val.toLowerCase().includes("niedrig")) style = "trend-down";
        return `<span class="${style}">${val}</span>`;
    }

    // --- RENDER LOGIC ---
    function renderCards() {
        const term = document.getElementById('search').value.toLowerCase();
        const container = document.getElementById('card-container');
        container.innerHTML = '';

        const filtered = db.filter(item => {
            const str = (item.name + " " + item.def + " " + item.leitsymptome + " " + item.e_symptome).toLowerCase();
            return str.includes(term);
        });

        if(filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#90a4ae;">Keine Treffer gefunden.</div>';
            return;
        }

        filtered.forEach(item => {
            // Helper f√ºr Grid Items
            const itemHTML = (icon, label, val, full=false) => {
                if(!val || val.trim()==="") return "";
                const gridClass = full ? 'info-full' : 'info-item';
                return `<div class="${gridClass}">
                    <div class="info-label">${icon} ${label}</div>
                    <div class="info-val">${formatValue(val)}</div>
                </div>`;
            };

            const nefBadge = item.nef ? `<span class="nef-badge">NEF</span>` : '';
            const icon = item.icon ? item.icon : 'üöë';

            // HTML Konstruktion
            const html = `
            <div class="card">
                <div class="card-header ${item.category}" onclick="toggleCard(this)">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:1.6rem;">${icon}</span>
                        <span style="font-weight:700; font-size:1.1rem;">${item.name}</span>
                    </div>
                    <span class="toggle-arrow" style="opacity:0.8">‚ñº</span>
                </div>
                
                <!-- PREVIEW -->
                <div class="card-preview" onclick="toggleCard(this.previousElementSibling)">
                    ${item.def ? `<div class="def-text">${item.def}</div>` : ''}
                    <div style="display:flex; gap:10px; margin-top:5px; color:#78909c; font-size:0.85rem;">
                         <span>${item.lagerung ? 'üõèÔ∏è ' + item.lagerung : ''}</span>
                         <span>${item.nef ? 'üìû NEF' : ''}</span>
                    </div>
                </div>

                <div class="card-details">
                    <!-- LEITSYMPTOME (GELB) -->
                    ${item.leitsymptome ? `
                    <div class="symptom-box">
                        <span class="icon">‚ö†Ô∏è</span>
                        <span class="text">${item.leitsymptome}</span>
                    </div>` : ''}

                    <!-- COCKPIT: VITALWERTE (Wenn vorhanden) -->
                    ${(item.c_herzfrequenz || item.c_blutdruck || item.b_atemfrequenz || item.b_spo2) ? `
                    <div class="cockpit">
                        ${item.c_herzfrequenz ? `<div class="vital-tile"><div class="vital-label">‚ù§Ô∏è Puls</div><div class="vital-val">${formatValue(item.c_herzfrequenz)}</div></div>` : ''}
                        ${item.c_blutdruck ? `<div class="vital-tile"><div class="vital-label">ü©∏ RR</div><div class="vital-val">${formatValue(item.c_blutdruck)}</div></div>` : ''}
                        ${item.b_spo2 ? `<div class="vital-tile"><div class="vital-label">‚òÅÔ∏è SpO2</div><div class="vital-val">${formatValue(item.b_spo2)}</div></div>` : ''}
                        ${item.b_atemfrequenz ? `<div class="vital-tile"><div class="vital-label">üí® AF</div><div class="vital-val">${formatValue(item.b_atemfrequenz)}</div></div>` : ''}
                    </div>` : ''}

                    <!-- A & B: ATMUNG (BLAU) -->
                    <div class="abc-section sec-ab">
                        <div class="sec-title" style="color:var(--col-ab)">ü´Å Airway & Breathing</div>
                        <div class="info-grid">
                            ${itemHTML('üó£Ô∏è', 'Atemwege', item.a_atemwege, true)}
                            ${itemHTML('üîä', 'Ger√§usche', item.b_atemgeraeusche)}
                            ${itemHTML('üòÆ', 'Atemnot', item.b_atemnot)}
                            ${itemHTML('üîµ', 'Zyanose', item.b_zyanose)}
                            ${itemHTML('üëî', 'Halsvenen', item.b_halsvenen)}
                        </div>
                    </div>

                    <!-- C: KREISLAUF (ROT) -->
                    <div class="abc-section sec-c">
                        <div class="sec-title" style="color:var(--col-c)">‚ù§Ô∏è Circulation</div>
                        <div class="info-grid">
                            ${itemHTML('üé®', 'Hautstatus', item.c_haut, true)}
                            ${itemHTML('üëÅÔ∏è', 'Erster Eindruck', item.erster_eindruck, true)}
                        </div>
                    </div>

                    <!-- D: NEURO (GELB) -->
                    <div class="abc-section sec-d">
                        <div class="sec-title" style="color:#f9a825">üß† Disability</div>
                        <div class="info-grid">
                            ${itemHTML('üò¥', 'Bewusstsein', item.bewusstsein, true)}
                            ${itemHTML('üìä', 'GCS / AVPU', item.d_avpu)}
                            ${itemHTML('üç¨', 'Blutzucker', item.d_bz)}
                            ${itemHTML('üëÄ', 'Pupillen', item.d_pupillen)}
                            ${itemHTML('‚ö°', 'Kr√§mpfe', item.e_kraempfe)}
                            ${itemHTML('üí™', 'L√§hmung', item.e_laehmung)}
                            ${itemHTML('ü§ñ', 'FAST / Neuro', item.d_fast, true)}
                        </div>
                    </div>

                    <!-- E: EXPOSURE (GR√úN) -->
                    <div class="abc-section sec-e">
                        <div class="sec-title" style="color:var(--col-e)">üîç Exposure & Symptome</div>
                        <div class="info-grid">
                            ${itemHTML('ü§í', 'Spezifisch', item.e_symptome, true)}
                            ${itemHTML('üòñ', 'Schmerzen', item.e_schmerz)}
                            ${itemHTML('ü§¢', '√úbelkeit', item.e_nausea)}
                            ${itemHTML('üå°Ô∏è', 'Temperatur', item.e_temp)}
                            ${itemHTML('üö∞', 'Durst', item.e_durst)}
                            ${itemHTML('üöΩ', 'Ausscheidung', item.e_harn_stuhl)}
                        </div>
                    </div>

                    <!-- DIFFERENZIERUNG -->
                    ${(item.einteilung1 || item.einteilung2) ? `
                    <div class="diff-box">
                        <strong>üìå Differenzierung / Ursachen:</strong><br>
                        ${item.einteilung1 || ''}<br>
                        ${item.einteilung2 || ''}
                    </div>` : ''}

                    <!-- ACTION BAR (FOOTER) -->
                    <div class="action-bar">
                        <div class="action-item"><span class="action-icon">üõèÔ∏è</span> ${item.lagerung || '-'}</div>
                        <div class="action-item"><span class="action-icon">üí®</span> ${item.o2 || '-'}</div>
                        ${item.nef ? `<div class="action-item" style="grid-column: 1/-1; background:#c62828;"><span class="action-icon">üìû</span> Notarzt indikator!</div>` : ''}
                        ${item.absaugen ? `<div class="action-item"><span class="action-icon">ü™†</span> Absaugen</div>` : ''}
                         ${item.sonstiges ? `<div class="action-item" style="grid-column: 1/-1; font-style:italic">‚ÑπÔ∏è ${item.sonstiges}</div>` : ''}
                    </div>

                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function toggleCard(header) {
        const details = header.nextElementSibling.nextElementSibling;
        const arrow = header.querySelector('.toggle-arrow');
        const isOpen = details.classList.contains('open');
        details.classList.toggle('open');
        if(arrow) arrow.innerText = isOpen ? '‚ñº' : '‚ñ≤';
    }

    // --- COMPARE & QUIZ (Logik bleibt gleich) ---
    function initCompare() {
        const s1 = document.getElementById('s1');
        const s2 = document.getElementById('s2');
        s1.innerHTML = ''; s2.innerHTML = '';
        db.forEach(d => {
            const opt = `<option value="${d.id}">${d.name}</option>`;
            s1.insertAdjacentHTML('beforeend', opt);
            s2.insertAdjacentHTML('beforeend', opt);
        });
        if(db.length > 1) s2.value = db[1].id;
    }

    function renderCompare() {
        const id1 = document.getElementById('s1').value;
        const id2 = document.getElementById('s2').value;
        const d1 = db.find(x => x.id === id1);
        const d2 = db.find(x => x.id === id2);
        if(!d1 || !d2) return;
        const keys = [
            {l:'Lagerung', k:'lagerung'}, {l:'Leitsymptome', k:'leitsymptome'},
            {l:'Atmung', k:'b_atemgeraeusche'}, {l:'Haut', k:'c_haut'},
            {l:'Puls/RR', k:'c_blutdruck'}, {l:'Bewusstsein', k:'bewusstsein'},
            {l:'Pupillen', k:'d_pupillen'}
        ];
        let html = `<table class="comp-table">`;
        keys.forEach(row => {
            const v1 = d1[row.k] || '-';
            const v2 = d2[row.k] || '-';
            const highlight = (v1 !== v2 && v1 !== '-' && v2 !== '-') ? 'diff' : '';
            html += `<tr><th colspan="2">${row.l}</th></tr><tr class="${highlight}"><td>${formatValue(v1)}</td><td>${formatValue(v2)}</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('compare-result').innerHTML = html;
    }

    let currentQuizItem = null;
    function nextQuiz() {
        document.getElementById('q-sol').style.display = 'none';
        currentQuizItem = db[Math.floor(Math.random() * db.length)];
        const types = [];
        if(currentQuizItem.leitsymptome) types.push(`Ein Patient zeigt folgende Leitsymptome:\n\n"${currentQuizItem.leitsymptome}"\n\nWelches Notfallbild liegt vor?`);
        if(currentQuizItem.c_haut && currentQuizItem.b_atemgeraeusche) types.push(`Patientenstatus:\n\n‚Ä¢ Haut: ${currentQuizItem.c_haut}\n‚Ä¢ Atmung: ${currentQuizItem.b_atemgeraeusche}\n\nWelcher Verdacht?`);
        if(currentQuizItem.def) types.push(`Definition:\n"${currentQuizItem.def}"\n\nUm was handelt es sich?`);
        if(types.length === 0) types.push(`Welches Notfallbild wird hier gesucht?\n(Daten unvollst√§ndig f√ºr generierte Frage)`);
        document.getElementById('q-text').innerText = types[Math.floor(Math.random() * types.length)];
    }

    function solveQuiz() {
        document.getElementById('q-sol').style.display = 'block';
        document.getElementById('q-sol-icon').innerText = currentQuizItem.icon || 'üöë';
        document.getElementById('q-sol-title').innerText = currentQuizItem.name;
        document.getElementById('q-sol-desc').innerText = `Lagerung: ${currentQuizItem.lagerung || 'N/A'}\n\n${currentQuizItem.def || ''}`;
    }

    function nav(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewName).classList.add('active');
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + viewName).classList.add('active');
        window.scrollTo(0,0);
    }

    init();
</script>
</body>
</html>
