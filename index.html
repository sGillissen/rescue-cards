<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RescueCards V4 (Diagnose)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        :root {
            --primary: #0056b3;
            --bg: #eceff1;
            --text: #263238;
            --active-filter: #0288d1;
            
            /* Sektions-Farben */
            --col-ab: #0288d1; --col-c: #d32f2f; --col-d: #fbc02d; --col-e: #388e3c;
            
            /* Kategorien */
            --cat-neuro: #8e44ad; --cat-meta: #f39c12; --cat-resp: #27ae60; 
            --cat-cardio: #c0392b; --cat-trauma: #2980b9; --cat-other: #78909c;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        
        header { background: #263238; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        /* Suche & Filter Container */
        .controls { margin-top: 10px; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; background: #37474f; color: white; margin-bottom: 10px; }
        input::placeholder { color: #b0bec5; }

        /* FILTER CHIPS DESIGN */
        .filter-container { display: flex; flex-wrap: wrap; gap: 8px; padding-bottom: 5px; }
        .filter-chip { 
            background: #455a64; color: #cfd8dc; 
            padding: 6px 12px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: 600; cursor: pointer; 
            border: 1px solid #546e7a; transition: all 0.2s; user-select: none;
            display: flex; align-items: center; gap: 5px;
        }
        .filter-chip:hover { background: #546e7a; }
        .filter-chip.active { 
            background: #29b6f6; color: #000; border-color: #29b6f6; 
            box-shadow: 0 0 8px rgba(41, 182, 246, 0.4);
        }
        .filter-reset { background: #c62828; color: white; border-color: #c62828; display: none; }
        .filter-reset.visible { display: inline-flex; }

        /* Nav */
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        nav button { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #90a4ae; font-size: 0.75rem; text-transform: uppercase; }
        nav button.active { color: var(--col-ab); background: #e1f5fe; }

        /* Views */
        .view-section { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* Cards V3 Styles */
        .card { background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #cfd8dc; }
        .card-header { padding: 12px 15px; color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .neuro { background: var(--cat-neuro); } .meta { background: var(--cat-meta); } 
        .resp { background: var(--cat-resp); } .cardio { background: var(--cat-cardio); } 
        .trauma { background: var(--cat-trauma); } .other { background: var(--cat-other); }

        .card-preview { padding: 15px; cursor: pointer; }
        .def-text { font-style: italic; color: #546e7a; margin-bottom: 5px; font-size: 0.95rem; }
        
        .card-details { display: none; background: #fff; }
        .card-details.open { display: block; }
        .symptom-box { background: #fff8e1; color: #f57f17; padding: 12px 15px; border-bottom: 1px solid #ffe082; display: flex; gap: 10px; }
        
        /* Cockpit */
        .cockpit { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; }
        .vital-tile { background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0; text-align: center; }
        .vital-label { font-size: 0.7rem; color: #78909c; font-weight: 700; text-transform: uppercase; }
        .vital-val { font-weight: 800; font-size: 1rem; color: #37474f; }
        .trend-up { color: #d32f2f !important; } .trend-down { color: #1976d2 !important; }

        /* Sections */
        .abc-section { padding: 10px 15px; border-bottom: 1px solid #eee; }
        .abc-section.sec-ab { border-left: 5px solid var(--col-ab); }
        .abc-section.sec-c { border-left: 5px solid var(--col-c); }
        .abc-section.sec-d { border-left: 5px solid var(--col-d); }
        .abc-section.sec-e { border-left: 5px solid var(--col-e); }
        .sec-title { font-size: 0.75rem; font-weight: 900; text-transform: uppercase; margin-bottom: 8px; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-full { grid-column: 1 / -1; }
        .info-label { font-size: 0.7rem; color: #90a4ae; font-weight: 600; }
        .info-val { font-size: 0.95rem; color: #263238; font-weight: 500; }

        /* Action Bar */
        .action-bar { background: #263238; color: white; padding: 12px 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .action-item { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .nef-badge { background: #c62828; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: auto; }
        .diff-box { background: #fff3e0; padding: 10px 15px; border-top: 1px solid #ffe0b2; font-size: 0.9rem; color: #e65100; }

        #status-msg { text-align: center; padding: 40px 20px; color: #666; }
        .quiz-box { background: white; padding: 25px; border-radius: 12px; text-align: center; }
        .btn { background: var(--col-ab); color: white; padding: 14px 30px; border-radius: 30px; border: none; font-size: 1rem; margin-top: 15px; cursor: pointer; width: 100%; font-weight: bold; }
        .comp-table { width: 100%; border-collapse: collapse; background: white; }
        .comp-table td { border-bottom: 1px solid #eee; padding: 12px; width: 50%; vertical-align: top; }
    </style>
</head>
<body>

<header>
    <h1>üöë RescueCards <small>v4</small></h1>
    <div class="controls">
        <input type="text" id="search" placeholder="Suche Text (z.B. Apoplex)..." onkeyup="renderCards()">
        
        <!-- NEU: FILTER BUTTONS -->
        <div class="filter-container" id="filter-container">
            <!-- Reset Button -->
            <div class="filter-chip filter-reset" onclick="resetFilters()">‚úñ Reset</div>
            
            <!-- Dynamische Filter werden hier per JS eingef√ºgt -->
        </div>
    </div>
</header>

<div id="status-msg"><h3>Lade Daten...</h3><p>‚è≥</p></div>

<!-- VIEWS -->
<div id="learn" class="view-section"><div id="card-container"></div></div>
<div id="compare" class="view-section">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <select id="s1" onchange="renderCompare()" style="width:100%; padding:10px;"></select>
        <select id="s2" onchange="renderCompare()" style="width:100%; padding:10px;"></select>
    </div>
    <div id="compare-result"></div>
</div>
<div id="quiz" class="view-section">
    <div class="quiz-box">
        <h3 id="q-text" style="min-height:80px;">Lade Frage...</h3>
        <button class="btn" onclick="solveQuiz()">Aufl√∂sen</button>
        <div id="q-sol" style="display:none; margin-top:20px; text-align:left; background:#f5f5f5; padding:20px; border-radius:8px;">
            <h2 id="q-sol-title"></h2>
            <div id="q-sol-desc"></div>
            <button class="btn" style="background:transparent; border:2px solid #000; color:#000;" onclick="nextQuiz()">Weiter</button>
        </div>
    </div>
</div>

<nav>
    <button onclick="nav('learn')" id="btn-learn">üóÇÔ∏è Karten</button>
    <button onclick="nav('compare')" id="btn-compare">‚öñÔ∏è Vergleich</button>
    <button onclick="nav('quiz')" id="btn-quiz">üß† Quiz</button>
</nav>

<script>
    const GOOGLE_CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBMZadFA7O2nMGOeaUcnEZz5MuNW2WeHdmSU_m94SI9VDdUiI8AfsJXJ-KAhtxv0zRZ6pkRIM_jj1X/pub?gid=1914308692&single=true&output=csv";
    const PROXY_URL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(GOOGLE_CSV_LINK);
    
    let db = [];
    let activeFilters = new Set();

    // --- 1. FILTER DEFINITIONEN (Die "Intelligenz") ---
    // Hier definieren wir, was "RR Hoch" eigentlich im CSV bedeutet
    const filterDefs = [
        { id: 'rr_high', label: 'ü©∏ RR ‚¨ÜÔ∏è', check: (i) => isHigh(i.c_blutdruck) },
        { id: 'rr_low',  label: 'ü©∏ RR ‚¨áÔ∏è', check: (i) => isLow(i.c_blutdruck) },
        { id: 'hr_high', label: '‚ù§Ô∏è Puls ‚¨ÜÔ∏è', check: (i) => isHigh(i.c_herzfrequenz) },
        { id: 'sp_low',  label: '‚òÅÔ∏è SpO2 ‚¨áÔ∏è', check: (i) => isLow(i.b_spo2) || i.b_zyanose?.includes('ja') },
        { id: 'cyan',    label: 'üîµ Zyanose', check: (i) => hasText(i.b_zyanose, 'ja', 'zyanose', 'blau') || hasText(i.c_haut, 'zyanose') },
        { id: 'temp',    label: 'üå°Ô∏è Fieber', check: (i) => isHigh(i.e_temp) || hasText(i.e_temp, 'fieber', 'hei√ü') },
        { id: 'coma',    label: 'üß† Bewusstlos', check: (i) => hasText(i.bewusstsein, 'bewusstlos', 'koma', 'somnolent') },
        { id: 'pain',    label: '‚ö° Schmerz', check: (i) => hasText(i.e_schmerz, 'ja') || hasText(i.e_nausea, 'schmerz') }
    ];

    // Helper zur Interpretation der Icons/Texte
    function isHigh(val) { 
        if(!val) return false; 
        val = val.toLowerCase();
        return val.includes('‚¨ÜÔ∏è') || val.includes('hoch') || val.includes('>') || val.includes('+');
    }
    function isLow(val) { 
        if(!val) return false; 
        val = val.toLowerCase();
        return val.includes('‚¨áÔ∏è') || val.includes('niedrig') || val.includes('<') || val.includes('-');
    }
    function hasText(val, ...terms) {
        if(!val) return false;
        val = val.toLowerCase();
        return terms.some(t => val.includes(t));
    }

    // --- INIT ---
    async function init() {
        renderFilterButtons();
        try { await loadData(GOOGLE_CSV_LINK); } 
        catch (e1) { try { await loadData(PROXY_URL); } catch(e2) {} }
    }

    function renderFilterButtons() {
        const container = document.getElementById('filter-container');
        filterDefs.forEach(f => {
            const btn = document.createElement('div');
            btn.className = 'filter-chip';
            btn.innerText = f.label;
            btn.onclick = () => toggleFilter(f.id, btn);
            container.appendChild(btn);
        });
    }

    function toggleFilter(id, btnElement) {
        if(activeFilters.has(id)) {
            activeFilters.delete(id);
            btnElement.classList.remove('active');
        } else {
            activeFilters.add(id);
            btnElement.classList.add('active');
        }
        
        // Reset Button anzeigen wenn Filter aktiv
        document.querySelector('.filter-reset').classList.toggle('visible', activeFilters.size > 0);
        renderCards(); // Neu filtern
    }

    function resetFilters() {
        activeFilters.clear();
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
        document.querySelector('.filter-reset').classList.remove('visible');
        renderCards();
    }

    function loadData(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    db = results.data.filter(row => row.id && row.name);
                    if(db.length > 0) {
                        document.getElementById('status-msg').style.display = 'none';
                        nav('learn'); renderCards(); initCompare(); nextQuiz(); resolve();
                    }
                }
            });
        });
    }

    // --- FORMAT HELPER ---
    function formatValue(val) {
        if (!val) return "";
        let style = "";
        if (isHigh(val)) style = "trend-up";
        if (isLow(val)) style = "trend-down";
        return `<span class="${style}">${val}</span>`;
    }

    // --- MAIN RENDER LOGIC ---
    function renderCards() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const container = document.getElementById('card-container');
        container.innerHTML = '';

        // FILTER LOGIK: Text-Suche UND alle aktiven Filter Chips m√ºssen passen (AND)
        const filtered = db.filter(item => {
            // 1. Text Suche
            const textMatch = (item.name + item.def + item.leitsymptome + item.e_symptome).toLowerCase().includes(searchTerm);
            if(!textMatch) return false;

            // 2. Chip Filter (Alle aktiven m√ºssen wahr sein)
            for (let filterId of activeFilters) {
                const def = filterDefs.find(d => d.id === filterId);
                if (def && !def.check(item)) return false; // Wenn Check fehlschl√§gt, rauswerfen
            }
            return true;
        });

        if(filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#90a4ae;">Keine Treffer f√ºr diese Kombination.</div>';
            return;
        }

        filtered.forEach(item => {
            const itemHTML = (icon, label, val, full=false) => {
                if(!val || val.trim()==="") return "";
                return `<div class="${full?'info-full':'info-item'}"><div class="info-label">${icon} ${label}</div><div class="info-val">${formatValue(val)}</div></div>`;
            };

            const html = `
            <div class="card">
                <div class="card-header ${item.category}" onclick="toggleCard(this)">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:1.6rem;">${item.icon||'üöë'}</span>
                        <span style="font-weight:700; font-size:1.1rem;">${item.name}</span>
                    </div>
                    <span class="toggle-arrow" style="opacity:0.8">‚ñº</span>
                </div>
                
                <div class="card-preview" onclick="toggleCard(this.previousElementSibling)">
                    ${item.def ? `<div class="def-text">${item.def}</div>` : ''}
                    <div style="display:flex; gap:10px; margin-top:5px; color:#78909c; font-size:0.85rem;">
                         <span>${item.lagerung ? 'üõèÔ∏è ' + item.lagerung : ''}</span>
                         <span>${item.nef ? 'üìû NEF' : ''}</span>
                    </div>
                </div>

                <div class="card-details">
                    ${item.leitsymptome ? `<div class="symptom-box"><span class="icon">‚ö†Ô∏è</span><span class="text">${item.leitsymptome}</span></div>` : ''}

                    ${(item.c_herzfrequenz || item.c_blutdruck || item.b_atemfrequenz || item.b_spo2) ? `
                    <div class="cockpit">
                        ${item.c_herzfrequenz ? `<div class="vital-tile"><div class="vital-label">‚ù§Ô∏è Puls</div><div class="vital-val">${formatValue(item.c_herzfrequenz)}</div></div>` : ''}
                        ${item.c_blutdruck ? `<div class="vital-tile"><div class="vital-label">ü©∏ RR</div><div class="vital-val">${formatValue(item.c_blutdruck)}</div></div>` : ''}
                        ${item.b_spo2 ? `<div class="vital-tile"><div class="vital-label">‚òÅÔ∏è SpO2</div><div class="vital-val">${formatValue(item.b_spo2)}</div></div>` : ''}
                        ${item.b_atemfrequenz ? `<div class="vital-tile"><div class="vital-label">üí® AF</div><div class="vital-val">${formatValue(item.b_atemfrequenz)}</div></div>` : ''}
                    </div>` : ''}

                    <div class="abc-section sec-ab">
                        <div class="sec-title" style="color:var(--col-ab)">ü´Å Airway & Breathing</div>
                        <div class="info-grid">
                            ${itemHTML('üó£Ô∏è', 'Atemwege', item.a_atemwege, true)}
                            ${itemHTML('üîä', 'Ger√§usche', item.b_atemgeraeusche)}
                            ${itemHTML('üòÆ', 'Atemnot', item.b_atemnot)}
                            ${itemHTML('üîµ', 'Zyanose', item.b_zyanose)}
                            ${itemHTML('üëî', 'Halsvenen', item.b_halsvenen)}
                        </div>
                    </div>

                    <div class="abc-section sec-c">
                        <div class="sec-title" style="color:var(--col-c)">‚ù§Ô∏è Circulation</div>
                        <div class="info-grid">
                            ${itemHTML('üé®', 'Hautstatus', item.c_haut, true)}
                            ${itemHTML('üëÅÔ∏è', 'Erster Eindruck', item.erster_eindruck, true)}
                        </div>
                    </div>

                    <div class="abc-section sec-d">
                        <div class="sec-title" style="color:#f9a825">üß† Disability</div>
                        <div class="info-grid">
                            ${itemHTML('üò¥', 'Bewusstsein', item.bewusstsein, true)}
                            ${itemHTML('üìä', 'GCS / AVPU', item.d_avpu)}
                            ${itemHTML('üç¨', 'Blutzucker', item.d_bz)}
                            ${itemHTML('üëÄ', 'Pupillen', item.d_pupillen)}
                            ${itemHTML('‚ö°', 'Kr√§mpfe', item.e_kraempfe)}
                            ${itemHTML('üí™', 'L√§hmung', item.e_laehmung)}
                            ${itemHTML('ü§ñ', 'FAST / Neuro', item.d_fast, true)}
                            ${itemHTML('üìù', 'Sonstiges', item.d_sonstiges, true)}
                        </div>
                    </div>

                    <div class="abc-section sec-e">
                        <div class="sec-title" style="color:var(--col-e)">üîç Exposure & Symptome</div>
                        <div class="info-grid">
                            ${itemHTML('ü§í', 'Spezifisch', item.e_symptome, true)}
                            ${itemHTML('üòñ', 'Schmerzen', item.e_schmerz)}
                            ${itemHTML('ü§¢', '√úbelkeit', item.e_nausea)}
                            ${itemHTML('üå°Ô∏è', 'Temperatur', item.e_temp)}
                            ${itemHTML('üö∞', 'Durst', item.e_durst)}
                            ${itemHTML('üöΩ', 'Ausscheidung', item.e_harn_stuhl)}
                        </div>
                    </div>

                    ${(item.einteilung1 || item.einteilung2) ? `<div class="diff-box"><strong>üìå Differenzierung:</strong><br>${item.einteilung1 || ''}<br>${item.einteilung2 || ''}</div>` : ''}

                    <div class="action-bar">
                        <div class="action-item"><span class="action-icon">üõèÔ∏è</span> ${item.lagerung || '-'}</div>
                        <div class="action-item"><span class="action-icon">üí®</span> ${item.o2 || '-'}</div>
                        ${item.nef ? `<div class="action-item" style="grid-column: 1/-1; background:#c62828;"><span class="action-icon">üìû</span> Notarzt indikator!</div>` : ''}
                        ${item.absaugen ? `<div class="action-item"><span class="action-icon">ü™†</span> Absaugen</div>` : ''}
                         ${item.sonstiges ? `<div class="action-item" style="grid-column: 1/-1; font-style:italic">‚ÑπÔ∏è ${item.sonstiges}</div>` : ''}
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function toggleCard(header) {
        const details = header.nextElementSibling.nextElementSibling;
        const arrow = header.querySelector('.toggle-arrow');
        const isOpen = details.classList.contains('open');
        details.classList.toggle('open');
        if(arrow) arrow.innerText = isOpen ? '‚ñº' : '‚ñ≤';
    }

    // --- COMPARE & QUIZ ---
    function initCompare() {
        const s1 = document.getElementById('s1');
        const s2 = document.getElementById('s2');
        s1.innerHTML = ''; s2.innerHTML = '';
        db.forEach(d => {
            const opt = `<option value="${d.id}">${d.name}</option>`;
            s1.insertAdjacentHTML('beforeend', opt);
            s2.insertAdjacentHTML('beforeend', opt);
        });
        if(db.length > 1) s2.value = db[1].id;
    }

    function renderCompare() {
        const id1 = document.getElementById('s1').value;
        const id2 = document.getElementById('s2').value;
        const d1 = db.find(x => x.id === id1);
        const d2 = db.find(x => x.id === id2);
        if(!d1 || !d2) return;
        const keys = [
            {l:'Lagerung', k:'lagerung'}, {l:'Leitsymptome', k:'leitsymptome'},
            {l:'Atmung', k:'b_atemgeraeusche'}, {l:'Haut', k:'c_haut'},
            {l:'Puls/RR', k:'c_blutdruck'}, {l:'Bewusstsein', k:'bewusstsein'},
            {l:'Pupillen', k:'d_pupillen'}
        ];
        let html = `<table class="comp-table">`;
        keys.forEach(row => {
            const v1 = d1[row.k] || '-';
            const v2 = d2[row.k] || '-';
            const highlight = (v1 !== v2 && v1 !== '-' && v2 !== '-') ? 'diff' : '';
            html += `<tr><th colspan="2">${row.l}</th></tr><tr class="${highlight}"><td>${formatValue(v1)}</td><td>${formatValue(v2)}</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('compare-result').innerHTML = html;
    }

    let currentQuizItem = null;
    function nextQuiz() {
        document.getElementById('q-sol').style.display = 'none';
        currentQuizItem = db[Math.floor(Math.random() * db.length)];
        const types = [`Leitsymptome:\n"${currentQuizItem.leitsymptome || '?'}"\n\nDiagnose?`, `Haut: ${currentQuizItem.c_haut}\nAtmung: ${currentQuizItem.b_atemgeraeusche}\n\nVerdacht?`];
        document.getElementById('q-text').innerText = types[Math.floor(Math.random() * types.length)];
    }
    function solveQuiz() {
        document.getElementById('q-sol').style.display = 'block';
        document.getElementById('q-sol-title').innerText = currentQuizItem.name;
        document.getElementById('q-sol-desc').innerText = `Lagerung: ${currentQuizItem.lagerung}`;
    }

    function nav(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewName).classList.add('active');
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + viewName).classList.add('active');
        window.scrollTo(0,0);
    }

    init();
</script>
</body>
</html>
